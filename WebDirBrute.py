import os
from lib.core.common import *
from urllib.parse import urljoin
from urllib.parse import urlparse
from lib.core.requestsCore import requests_responses


def DirBrute(urls):
    targets = list()
    directory_filename = os.path.join("data","dicts","dirsearch_dicc.txt")

    for url in urls:
        _parser = urlparse(url)
        target = urljoin( _parser.scheme + "://" + _parser.netloc + _parser.path , "./")
        targets.append( target )
        print(f"[*] Web directory brute : {target}")

    tasks = list()
    with open(directory_filename) as directory_file:
        print(f"[*] Directory Loading {directory_filename} ...")

        for line in directory_file:

            for url in targets:
                tasks.append( {"webroot":url, "path": line.strip()} )

    directories_result = requests_responses( tasks )

    SensitiveDirectories = list()
    for webroot in list(set([RequestProcessor(_.get("url")).get("webroot") for _ in directories_result if _])):
        site_directories = list()
        for directory in directories_result:
            if RequestProcessor(directory.get("url")).get("webroot")==webroot:
                site_directories.append(directory)
        
        print(f"[*] \033[38;4;250;255;114m{webroot}\033[0m Extracting Key \033[38;2;112;243;255m{len(site_directories)}\033[0m Directory .")
        SensitiveDirectories.extend( ExtractKeyResponses(site_directories) )

        SensitiveDirectories.sort(key=lambda response: response.get('status_code'))
        for response in SensitiveDirectories:
            if response.get('status_code') and str(response['status_code'])[0]=='2':
                print(f"\033[1;32m[{response.get('status_code')}]  {str(response.get('text_length')).ljust(7)}  {response.get('url')}    {'<'+response.get('title')+'>' if response.get('title') else str()}  \033[0m")

            elif response.get('status_code') and str(response['status_code'])[0]=='4':
                print(f"\033[1;34m[{response.get('status_code')}]  {str(response.get('text_length')).ljust(7)}  {response.get('url')}    {'<'+response.get('title')+'>' if response.get('title') else str()}  \033[0m")

            elif response.get('status_code') and str(response['status_code'])[0]=='3':
                print(f"\033[38;2;251;210;106m[{response.get('status_code')}]  {str(response.get('text_length')).ljust(7)}  {response.get('url')}    {'<'+response.get('title')+'>' if response.get('title') else str()}  \033[0m")

            elif response.get('status_code') and str(response['status_code'])[0]=='5':
                print(f"\033[38;2;251;78;32m[{response.get('status_code')}]  {str(response.get('text_length')).ljust(7)}  {response.get('url')}    {'<'+response.get('title')+'>' if response.get('title') else str()}  \033[0m")

            else:
                print(f"\033[38;2;242;236;222m[{response.get('status_code')}]  {str(response.get('text_length')).ljust(7)}  {response.get('url')}    {'<'+response.get('title')+'>' if response.get('title') else str()}  \033[0m")


if __name__=="__main__":
    import sys
    DirBrute( [sys.argv[1]] )
